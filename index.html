<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Play Ground</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
        <script src="https://connect.facebook.net/en_US/sdk.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <style type="text/css">
            .background {
                background: black;
                color: white;                
            }

            .fullscreen:-webkit-full-screen {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                background: black;
            }

            .fullscreen img {
                display: none;
            }

            .fullscreen:-webkit-full-screen img {
                display: block;
                width: auto;
                height: 100%;
                margin: 0 auto;
            }
        </style>
    </head>
    <body class="background">
        </br></br>
        <div class="container">
            <div class="form-group row">
                <div class="col-2 text-right">
                    <label>AccessToken :</label>        
                </div>
                <div class="col-8">
                    <div class="input-group input-group-sm">
                        <input id="txtAccessToken" type="text" class="form-control" >
                        <div class="input-group-append">
                            <a class="input-group-text btn btn-primary" href="https://developers.facebook.com/tools/explorer" target="_blank" >Get Token</a>
                        </div>
                      </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-2 text-right">
                    <label>Source :</label>        
                </div>
                <div class="col-8">
                    <select id="ddlPageId" class="form-control form-control-sm">
                        <option value="399814953400318">Contrast</option>
                        <!--<option value="293144433802">MarsMagazine</option>
                        <option value="1142775052496607">ดีต่อใจ</option>
                        <option value="349084361853587">SexyDanceFanpage</option>
                        <option value="306305343204930">Sexyclub20up</option>
                        <option value="1623386207976420">SexyAngels</option>
                        <option value="958865924218839">CupE</option>
                        <option value="697857217063434">AboutG</option> -->
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <div class="col-2 text-right">
                    <label>Type :</label>        
                </div>
                <div class="col-8">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="rdoType" id="rdoType1" value="image" checked>
                        <label class="form-check-label" for="rdoType1">Image</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="rdoType" id="rdoType2" value="video" >
                        <label class="form-check-label" for="rdoType2">Video</label>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-12 text-center">
                    <button id="btnSubmit" class="btn btn-sm btn-primary"> Search </label>      
                </div>
            </div>
        </div>
        <div id="gallery" class="background"></div>
        <div id="fullScreen" class="fullscreen background">
            <img src="#" ></img>
        </div>

        <script>
            var settings = {
                AppId : '649223465416475',
                AppVersion : 'v3.0',
                AppAccessToken : '',
            }

            var data = {
                CurrentPage : '',
                NextPage : '',
                PreviousPage : '',
                Count : 0,
                Items : []
            } 

            $(function() {
                FB.init({
                    appId: settings.AppId,
                    version: settings.AppVersion
                });     
            
                /*FB.getLoginStatus(function(res) {
                    fbLoginStateCallBack(res);
                });*/

                init();
            }); 

            function init(){
                $('#txtAccessToken').val(settings.AppAccessToken);

                $('#btnSubmit').on('click', function() {
                    var type = $('input[name="rdoType"]:checked').val();
                    if(type == 'image'){
                        getImages($('#ddlPageId').val(), data.NextPage);
                    }
                    else if(type == 'video'){
                        getVideos($('#ddlPageId').val(), data.NextPage);
                    }
                });

                $('input[name="rdoType"],#ddlPageId').on('change',function(e){
                    $('#gallery').empty();
                    data.CurrentPage = '';
                    data.NextPage = '';
                    data.PreviousPage = '';
                    data.Items = [];
                });

                $(window).scroll(function() {
                    var type = $('input[name="rdoType"]:checked').val();
                    if(type == 'image'){
                        getImages($('#ddlPageId').val(), data.NextPage);
                    }
                    else if(type == 'video'){
                        getVideos($('#ddlPageId').val(), data.NextPage);
                    }
                });
            }

            function fbLoginStateCallBack(res){
                if (res.status === 'connected') {
                    settings.AppAccessToken = res.authResponse.accessToken;
                    $('#txtAccessToken').val(settings.AppAccessToken);
                } 
                else{
                    var result = confirm('Continue With Facebook');
                    if(result){
                        FB.login(function(res) {
                            fbLoginStateCallBack(res)
                        });
                    }
                }
            }

            function getImages(pageId, next) {
                var accessToken = $('#txtAccessToken').val();
                var url = '/' + pageId + '/photos';
                var args = { 
                    access_token: accessToken,
                    fields : 'images',
                    type: 'uploaded',
                    limit: 25,
                    after: next
                };

                if(data.CurrentPage == '' || data.CurrentPage != next) {
                    FB.api(url, args, function(res) {
                        if(res.data){
                            updateGallery(res.data, 'image');
                        }

                        if(res.paging){
                            data.NextPage = res.paging.cursors.after;
                            data.PreviousPage = res.paging.cursors.before;
                        }
                
                    });
                }

                data.CurrentPage = next;
            }

            function getVideos(pageId, next){
                var accessToken = $('#txtAccessToken').val();
                var url = '/' + pageId + '/videos';
                var args = { 
                    access_token: accessToken,
                    fields : 'picture,embed_html',
                    limit: 25,
                    after: next
                };

                if(data.CurrentPage == '' || data.CurrentPage != next) {
                    FB.api(url, args, function(res) {
                                
                        if(res.data){
                            updateGallery(res.data, 'video');
                        }

                        if(res.paging){
                            data.NextPage = res.paging.cursors.after;
                            data.PreviousPage = res.paging.cursors.before;
                        }
                    });
                }

                data.CurrentPage = next;
            }

            function updateGallery(items, type) {
                var $container = $('#gallery');
                if(type == 'image'){
                    $.each(items, function(i, img) {
                        var source = img.images[img.images.length - 2].source;
                        $container.append('<img src="' + source + '" onclick="openFullScreenImage(\''+ img.images[0].source + '\')" class="col-3 rounded">');
                        //$container.append('<img src="' + source + '" onclick="openImage(\''+ img.images[0].source + '\')" class="col-3 rounded">');
                        //data.Items.append({Type:'Video', Soruce : source});
                    });
                }
                else if(type == 'video'){
                    $.each(items, function(i, video) {
                        var source = $(video.embed_html).attr('src') + '&mute=0';
                        $container.append('<img src="' + video.picture + '" onclick="openImage(\'' + source +'\')"  class="col-3 rounded">');
                        //data.Items.append({Type:'Video', Soruce : source});
                    });
                }
            }

            function openImage(src) {
                var win = window.open(src, '_blank');
                win.focus();
            }

            function openFullScreenImage(src) {
                var divObj = document.getElementById('fullScreen');
                
                $(divObj).children('img').attr('src', src);
                
                if (divObj.requestFullscreen) {
                    divObj.requestFullscreen();
                }
                else if (divObj.msRequestFullscreen) {
                    divObj.msRequestFullscreen();               
                }
                else if (divObj.mozRequestFullScreen) {
                    divObj.mozRequestFullScreen();      
                }
                else if (divObj.webkitRequestFullscreen) {
                    divObj.webkitRequestFullscreen();       
                } 
                else {
                    console.log("Fullscreen API is not supported");
                } 
            }

        </script>
    </body>
</html>
